/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/Core","sap/ui/base/ManagedObjectObserver","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ItemNavigation","sap/f/GridContainerRenderer","sap/ui/Device","sap/ui/layout/cssgrid/VirtualGrid","sap/f/GridContainerSettings","sap/base/strings/capitalize","sap/ui/core/InvisibleRenderer"],function(t,e,i,r,n,s,o,a,l,u,h,f){"use strict";var g=i.getConfiguration().getRTL();var p=16;var d=["sap.f.Card","sap.ui.integration.widgets.Card","sap.m.GenericTile"];function c(){return!a.browser.msie&&!(a.browser.edge&&a.browser.version<p)}function m(t){var e=t.getLayoutData();return e?e.getColumns():1}function y(t){var e=t.getLayoutData();return e?e.getActualRows():1}function _(t){var e=t.getLayoutData();return e?e.hasAutoHeight():true}var v=e.extend("sap.f.GridContainer",{metadata:{library:"sap.f",interfaces:["sap.f.dnd.IGridDroppable"],properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},containerQuery:{type:"boolean",group:"Behavior",defaultValue:false},snapToRow:{type:"boolean",group:"Appearance",defaultValue:false},allowDenseFill:{type:"boolean",group:"Appearance",defaultValue:false},inlineBlockLayout:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Control",multiple:true,singularName:"item",dnd:true},layout:{type:"sap.f.GridContainerSettings",multiple:false},layoutXS:{type:"sap.f.GridContainerSettings",multiple:false},layoutS:{type:"sap.f.GridContainerSettings",multiple:false},layoutM:{type:"sap.f.GridContainerSettings",multiple:false},layoutL:{type:"sap.f.GridContainerSettings",multiple:false},layoutXL:{type:"sap.f.GridContainerSettings",multiple:false},_defaultLayout:{type:"sap.f.GridContainerSettings",multiple:false,visibility:"hidden"}},events:{layoutChange:{parameters:{layout:{type:"string"}}},borderReached:{parameters:{event:{type:"jQuery.Event"}}}},dnd:{draggable:false,droppable:true}}});v.prototype.bUseExtendedChangeDetection=true;v.prototype.getActiveLayoutSettings=function(){var t=this.getAggregation(this._sActiveLayout);if(!t&&this._sActiveLayout==="layoutXS"){t=this.getAggregation("layoutS")}if(!t){t=this.getAggregation("layout")||this.getAggregation("_defaultLayout")}return t};v.prototype._onBeforeItemRendering=function(){var t=this.getParent();if(t._reflectItemVisibilityToWrapper(this)&&!c()){t._scheduleIEPolyfill()}};v.prototype._onAfterItemRendering=function(){var t=this.getParent(),e;if(t._hasOwnVisualFocus(this)){e=this.getFocusDomRef();e.setAttribute("tabindex",-1);e.tabIndex=-1}if(!t._resizeListeners[this.getId()]){t._resizeListeners[this.getId()]=n.register(this,t._resizeItemHandler)}t._setItemNavigationItems();if(!c()){t._scheduleIEPolyfill();return}t._applyItemAutoRows(this)};v.prototype._reflectItemVisibilityToWrapper=function(t){var e=t.getDomRef(),i=document.getElementById(f.createInvisiblePlaceholderId(t)),r,n;if(!e&&!i){return false}r=(e?e:i).parentElement;n=jQuery(r);if(t.getVisible()&&n.hasClass("sapFGridContainerInvisiblePlaceholder")){n.removeClass("sapFGridContainerInvisiblePlaceholder")}else if(!t.getVisible()&&!n.hasClass("sapFGridContainerInvisiblePlaceholder")){n.addClass("sapFGridContainerInvisiblePlaceholder");return true}return false};v.prototype._onItemChange=function(t){if(t.name!=="items"||!t.child){return}if(t.mutation==="insert"){t.child.addEventDelegate(this._itemDelegate,t.child)}else if(t.mutation==="remove"){t.child.removeEventDelegate(this._itemDelegate,t.child)}};v.prototype._deregisterResizeListeners=function(){var t,e;for(t in this._resizeListeners){e=this._resizeListeners[t];n.deregister(e)}delete this._resizeListeners;a.resize.detachHandler(this._resizeDeviceHandler)};v.prototype._setItemNavigationItems=function(){if(!this._isRenderingFinished){return}var t=this,e=[];if(!t._itemNavigation){t._itemNavigation=(new s).setCycling(false).attachEvent(s.Events.FocusLeave,this._onItemNavigationFocusLeave,this).attachEvent(s.Events.BorderReached,this._onItemNavigationBorderReached,this).setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"]});t.addDelegate(this._itemNavigation)}t.$().children().map(function(t,i){if(i.getAttribute("class").indexOf("sapFGridContainerItemWrapper")>-1){e.push(i)}});t._itemNavigation.setRootDomRef(t.getDomRef());t._itemNavigation.setItemDomRefs(e);t._itemNavigation.setFocusedIndex(0)};v.prototype._onItemNavigationFocusLeave=function(t){var e=this._itemNavigation.getFocusedDomRef();this._itemNavigation.getItemDomRefs().forEach(function(t,i){if(e===t){var r=i++;this._itemNavigation.setFocusedIndex(r)}}.bind(this));this._itemNavigationFocusLeft=true};v.prototype._detectActiveLayout=function(){var t=this.getContainerQuery()&&this.getDomRef()?this._getComputedWidth():a.resize.width,e=a.media.getCurrentRange("GridContainerRangeSet",t),i="layout"+e.name,r=this.getActiveLayoutSettings(),n=false;if(!t){return false}if(this._sActiveLayout!==i){this.addStyleClass("sapFGridContainer"+h(i));if(this._sActiveLayout){this.removeStyleClass("sapFGridContainer"+h(this._sActiveLayout))}this._sActiveLayout=i;n=r!==this.getActiveLayoutSettings();this.fireLayoutChange({layout:this._sActiveLayout})}return n};v.prototype._getActiveGridStyles=function(){var t=this.getActiveLayoutSettings(),e=t.getColumns()||"auto-fill",i=t.getColumnSize(),r=t.getMinColumnSize(),n=t.getMaxColumnSize(),s={"grid-gap":t.getGap()};if(r&&n){s["grid-template-columns"]="repeat("+e+", minmax("+r+", "+n+"))"}else{s["grid-template-columns"]="repeat("+e+", "+i+")"}if(this.getInlineBlockLayout()){s["grid-auto-rows"]="min-content"}else{s["grid-auto-rows"]=t.getRowSize()}return s};v.prototype.init=function(){this._oRb=i.getLibraryResourceBundle("sap.f");this.setAggregation("_defaultLayout",new u);this._initRangeSet();this._resizeListeners={};this._itemDelegate={onBeforeRendering:this._onBeforeItemRendering,onAfterRendering:this._onAfterItemRendering};this._itemsObserver=new r(this._onItemChange.bind(this));this._itemsObserver.observe(this,{aggregations:["items"]});this._resizeHandler=this._resize.bind(this);this._resizeDeviceHandler=this._resizeDevice.bind(this);a.resize.attachHandler(this._resizeDeviceHandler);this._resizeItemHandler=this._resizeItem.bind(this);if(!c()){this._attachDndPolyfill()}};v.prototype.insertItem=function(t,e){if(!this.getDomRef()||!c()){return this.insertAggregation("items",t,e)}var r=i.createRenderManager(),n=this._createItemWrapper(t),s=this._getItemAt(e),o=this.getDomRef();if(s){o.insertBefore(n,s.getDomRef().parentElement)}else{o.insertBefore(n,o.lastChild)}this.insertAggregation("items",t,e,true);t.addStyleClass("sapFGridContainerItemInnerWrapper");r.render(t,n);r.destroy();return this};v.prototype.removeItem=function(t){var e=this.removeAggregation("items",t,true),i=this.getDomRef(),r=e.getDomRef();if(!i||!r||!c()){this.invalidate();return e}i.removeChild(r.parentElement);return e};v.prototype.onBeforeRendering=function(){this._detectActiveLayout();var t=this._resizeListeners[this.getId()];if(t){n.deregister(t)}this._isRenderingFinished=false};v.prototype.onAfterRendering=function(){this._resizeListeners[this.getId()]=n.register(this.getDomRef(),this._resizeHandler);this._isRenderingFinished=true;this._setItemNavigationItems();this._applyLayout(true)};v.prototype.exit=function(){this._deregisterResizeListeners();if(this._itemsObserver){this._itemsObserver.disconnect();delete this._itemsObserver}if(this._itemNavigation){this.removeDelegate(this._itemNavigation);this._itemNavigation.destroy();delete this._itemNavigation;this._itemNavigation=null}if(!c()){this._detachDndPolyfill()}};v.prototype._initRangeSet=function(){if(!a.media.hasRangeSet("GridContainerRangeSet")){a.media.initRangeSet("GridContainerRangeSet",[375,600,1024,1440],"px",["XS","S","M","L","XL"])}};v.prototype._resize=function(){if(!this._isWidthChanged()){return}var t=this._detectActiveLayout();this._applyLayout(t)};v.prototype._resizeDevice=function(){if(!this.getContainerQuery()){this._resize()}};v.prototype._isWidthChanged=function(){var t=this._getComputedWidth(),e=a.resize.width;if(this._lastGridWidth===t&&this._lastViewportWidth===e){return false}this._lastGridWidth=t;this._lastViewportWidth=e;return true};v.prototype._getComputedWidth=function(){if(!this.getDomRef()){return null}return this.getDomRef().getBoundingClientRect().width};v.prototype._resizeItem=function(t){if(!c()){if(!this._bDraggingInAnotherContainer){this._scheduleIEPolyfill()}this._bDraggingInAnotherContainer=false;return}this._applyItemAutoRows(t.control)};v.prototype._applyLayout=function(t){if(!this._isRenderingFinished){return}if(!c()){this._scheduleIEPolyfill(t);return}if(t){this.$().css(this._getActiveGridStyles());this.getItems().forEach(this._applyItemAutoRows.bind(this))}this._enforceMaxColumns()};v.prototype._applyItemAutoRows=function(t){if(!this._isRenderingFinished){return}if(this.getInlineBlockLayout()){return}if(_(t)){var e=t.$(),i=this.getActiveLayoutSettings(),r=i.calculateRowsForItem(e.outerHeight());if(!r){return}e.parent().css({"grid-row":"span "+Math.max(r,y(t))})}};v.prototype._enforceMaxColumns=function(){var t=this.getActiveLayoutSettings(),e=t.getComputedColumnsCount(this.$().innerWidth());if(!e){return}this.getItems().forEach(function(t){t.$().parent().css("grid-column","span "+Math.min(m(t),e))})};v.prototype._getItemAt=function(t){var e=this.getItems(),i;if(t<0){t=0}if(e.length&&e[t]){i=e[t]}return i};v.prototype._createItemWrapper=function(t){var e=o.getStylesForItemWrapper(t,this),i=e.styles,r=e.classes,n=document.createElement("div");n.setAttribute("tabindex","0");i.forEach(function(t,e){n.style.setProperty(e,t)});r.forEach(function(t){n.classList.add(t)});return n};v.prototype._scheduleIEPolyfill=function(t){if(this._iPolyfillCallId){clearTimeout(this._iPolyfillCallId)}if(t){this._applyIEPolyfillLayout();return}this._iPolyfillCallId=setTimeout(this._applyIEPolyfillLayout.bind(this),0)};v.prototype._applyIEPolyfillLayout=function(){if(!this._isRenderingFinished){return}if(this.bIsDestroyed){return}var t=this.$(),e=t.innerWidth(),i=this.getActiveLayoutSettings(),r=i.getMinColumnSizeInPx()||i.getColumnSizeInPx(),n=i.getRowSizeInPx(),s=i.getGapInPx(),o=i.getComputedColumnsCount(e),a=parseInt(t.css("padding-top").replace("px","")),u=parseInt(t.css("padding-left").replace("px","")),h=this.getItems();if(!r||!n){return}if(!h.length){return}var f=new l;f.init({numberOfCols:Math.max(1,o),cellWidth:r,cellHeight:n,unitOfMeasure:"px",gapSize:s,topOffset:a?a:0,leftOffset:u?u:0,allowDenseFill:this.getAllowDenseFill(),rtl:g,width:e});var p,d,c,v,I,C,D=[];var R=function(t){f.fitElement(t+"",this._polyfillDropIndicator.columns||i.calculateColumnsForItem(Math.round(this._polyfillDropIndicator.width)),this._polyfillDropIndicator.rows||i.calculateRowsForItem(Math.round(this._polyfillDropIndicator.height)));D.push({id:t+"",domRef:this._polyfillDropIndicator.domRef})}.bind(this);for(p=0,d=0;p<h.length;p++){if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt===p){R(d);d++}c=h[p];v=c.$();if(!v.is(":visible")){continue}I=m(c);if(_(c)){C=this._calcAutoRowsForPolyfill(c,i)}else{C=y(c)}f.fitElement(d+"",I,C);D.push({id:d+"",domRef:v.parent()});d++}if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt>=h.length){R(h.length)}f.calculatePositions();D.forEach(function(t){var e=f.getItems()[t.id];t.domRef.css({position:"absolute",top:e.top,left:e.left,width:e.width,height:e.height})});t.css("height",f.getHeight()+"px");if(!this.getWidth()&&i.getColumns()){if(!this.getContainerQuery()){t.css("width",f.getWidth()+"px")}}};v.prototype._calcAutoRowsForPolyfill=function(t,e){var i=t.$(),r,n;if(i.hasClass("sapFCardAnalytical")){r=i[0].scrollHeight}else{r=i.outerHeight()}n=Math.max(e.calculateRowsForItem(r),y(t));return n};v.prototype._polyfillAfterDragOver=function(t){var e=t.getParameter("indicator");this._polyfillDropIndicator={rows:t.getParameter("rows"),columns:t.getParameter("columns"),width:t.getParameter("width"),height:t.getParameter("height"),domRef:e,insertAt:e.index()};this._scheduleIEPolyfill()};v.prototype._polyfillAfterDragEnd=function(t){this._polyfillDropIndicator=null};v.prototype._polyfillDraggingInAnotherContainer=function(){this._bDraggingInAnotherContainer=true};v.prototype._attachDndPolyfill=function(){this.attachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.attachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this);this.attachEvent("_gridPolyfillDraggingInAnotherContainer",this._polyfillDraggingInAnotherContainer,this)};v.prototype._detachDndPolyfill=function(){this.detachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.detachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this);this.detachEvent("_gridPolyfillDraggingInAnotherContainer",this._polyfillDraggingInAnotherContainer,this)};v.prototype.forwardTab=function(t){this.$(t?"after":"before").focus()};v.prototype.onsaptabnext=function(t){if(!this._itemNavigation){return}var e=this._itemNavigation.getItemDomRefs(),i=this._itemNavigation.getFocusedIndex(),r=jQuery(e[i]),n=[];var s=r.find(":sapTabbable");s.map(function(t,e){if(e.className.indexOf("DummyArea")===-1){n.push(e)}});var o=jQuery(n),a=o.length===1?0:o.length-1;if(a===-1||o.control(a)&&o.control(a).getId()===t.target.id){this._lastFocusedElement=t.target;this.forwardTab(true)}};v.prototype.onsaptabprevious=function(t){if(!t.target.classList.contains("sapFGridContainerItemWrapper")){this._lastFocusedElement=t.target;return}var e=t.target.id;if(e===this.getId("nodata")){this.forwardTab(false)}else if(e===this.getId("trigger")){this.focusPrevious();t.preventDefault()}this._lastFocusedElement=null;this.forwardTab(false)};v.prototype.onmousedown=function(t){this._bIsMouseDown=true};v.prototype.onmouseup=function(t){var e=jQuery(t.target).closest(".sapFGridContainerItemWrapperNoVisualFocus"),i;if(e.length){i=e.children().eq(0).control()[0];if(i&&i.getFocusDomRef()===document.activeElement){this._lastFocusedElement=null;e.focus()}}this._bIsMouseDown=false};v.prototype.onfocusin=function(t){var e=jQuery(t.target).closest(".sapFGridContainerItemWrapperNoVisualFocus"),i,r,n;if(!this._bIsMouseDown&&e.length){i=e.children().eq(0).control()[0];if(i&&i.getFocusDomRef()===t.target){this._lastFocusedElement=null;e.focus();return}}if(t.target.classList.contains("sapFGridContainerItemWrapper")){this._lastFocusedElement=null}if(this._itemNavigationFocusLeft){this._itemNavigationFocusLeft=false;r=this._itemNavigation.getItemDomRefs();n=this._itemNavigation.getFocusedIndex();if(this._lastFocusedElement){this._lastFocusedElement.focus()}else{r[n].focus()}}};v.prototype._onItemNavigationBorderReached=function(t){this.fireEvent("borderReached",{event:t.getParameter("event")})};v.prototype.onsapnext=function(t){var e=this._itemNavigation.getItemDomRefs();if(e.indexOf(t.target)===-1){t.stopImmediatePropagation(true)}};v.prototype.onsapprevious=function(t){var e=this._itemNavigation.getItemDomRefs();if(e.indexOf(t.target)===-1){t.stopImmediatePropagation(true)}};["onkeypress","onkeyup","onkeydown","onsapenter","onsapselect","onsapspace"].forEach(function(t){v.prototype[t]=function(e){if(!e.target.classList.contains("sapFGridContainerItemWrapper")){return}if(t==="onsapspace"){e.preventDefault()}var i=jQuery(e.target.firstChild).control()[0],r=i.getFocusDomRef(),n=jQuery(r).control()[0];if(n&&n[t]){n[t].call(n,e)}}});v.prototype._hasOwnVisualFocus=function(t){return d.indexOf(t.getMetadata().getName())>-1};return v});