/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,n,r,o,i){"use strict";function a(e){return i.get("content.createFunction",e)}function l(e,t){var n=e.content;if(n){return e.content.newFieldSelector&&e.content.newFieldIndex!==undefined&&e.content.bindingPath&&e.content.oDataServiceVersion&&!!a(t)}return false}function d(e){return e+"-field"}function c(e,t){var n=o({},e);n.fieldSelector.id=d(n.fieldSelector.id);return t.createControlForProperty(n).then(function(n){var r=e.modifier.getId(n.control);e.labelFor=r;return t.createLabel(e).then(function(e){return{label:e,control:n.control,valueHelp:n.valueHelp}})})}function f(e,t){var n=o({aggregationName:"formElements",payload:e.payload||{}},t);var r=e.instance;return Promise.resolve().then(function(){if(r.createLayout){return r.createLayout(n)}}).then(function(e){if(i.get("control",e)){e.layoutControl=true;return e}return c(n,r)})}function u(e,n){var i=o({},n);i.fieldSelector.id=d(i.fieldSelector.id);return t.getChangeHandlerSettings({scenario:"addODataFieldWithLabel",oDataServiceVersion:e.content&&e.content.oDataServiceVersion}).then(function(t){if(l(e,t)){var n=a(t);return n(i.modifier,i)}else{r.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+e.layer+"]"+e.namespace+"/"+e.fileName+"."+e.fileType)}})}var p={};p.applyChange=function(t,r,o){var i=t.getDefinition();var a=o.view;var l=i.content.newFieldIndex;var d=o.appComponent;var c=i.content;var p=c.newFieldSelector;var g={appComponent:o.appComponent,view:o.view,fieldSelector:p,bindingPath:c.bindingPath,modifier:o.modifier,element:r};if(o.modifier.bySelector(p,d)){return e.markAsNotApplicable("Control to be created already exists:"+p)}var v={newFieldSelector:p};return n.getDelegateForControl({control:r,modifier:o.modifier,modelType:c.modelType,supportsDefault:true}).then(function(e){var n=e?f(e,g):u(i,g);return n.then(function(e){var n;if(!e.layoutControl){n=o.modifier.createControl("sap.ui.layout.form.FormElement",d,a,p);o.modifier.insertAggregation(n,"label",e.label,0,a);o.modifier.insertAggregation(n,"fields",e.control,0,a)}else{n=e.control}var r=t.getDependentControl("parentFormContainer",o);o.modifier.insertAggregation(r,"formElements",n,l,a);if(e.valueHelp){o.modifier.insertAggregation(r,"dependents",e.valueHelp,0,a);var i=o.modifier.getSelector(o.modifier.getId(e.valueHelp),d);v.valueHelpSelector=i}t.setRevertData(v);return true})})};p.completeChangeContent=function(e,t,n){var r=n.appComponent;var o=e.getDefinition();if(!o.content){o.content={}}if(t.parentId){e.addDependentControl(t.parentId,"parentFormContainer",n)}else{throw new Error("oSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){o.content.bindingPath=t.bindingPath}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){o.content.newFieldSelector=n.modifier.getSelector(t.newControlId,r)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required")}else{o.content.newFieldIndex=t.index}if(t.oDataServiceVersion){o.content.oDataServiceVersion=t.oDataServiceVersion}if(t.modelType){o.content.modelType=t.modelType}};p.revertChange=function(e,t,n){var r=n.appComponent;var o=n.view;var i=n.modifier;var a=e.getRevertData().newFieldSelector;var l=e.getRevertData().valueHelpSelector;var d=i.bySelector(a,r,o);var c=e.getDependentControl("parentFormContainer",n);i.removeAggregation(c,"formElements",d);i.destroy(d);if(l){var f=i.bySelector(l,r,o);i.removeAggregation(c,"dependents",f);i.destroy(f)}e.resetRevertData();return true};return p},true);