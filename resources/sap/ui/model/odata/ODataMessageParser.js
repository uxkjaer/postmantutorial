/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/odata/ODataUtils","sap/ui/core/library","sap/ui/thirdparty/URI","sap/ui/core/message/MessageParser","sap/ui/core/message/Message","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,s,a,i,n){"use strict";var o="sap.ui.model.odata.ODataMessageParser",d=/^\/+|\/$/g,u=r.MessageType,l={error:u.Error,info:u.Information,success:u.Success,warning:u.Warning};var p=s.extend("sap.ui.model.odata.ODataMessageParser",{metadata:{publicMethods:["parse","setProcessor","getHeaderField","setHeaderField"]},constructor:function(e,r){s.apply(this);this._serviceUrl=c(this._parseUrl(e).url);this._metadata=r;this._processor=null;this._headerField="sap-message";this._lastMessages=[]}});p.prototype.getHeaderField=function(){return this._headerField};p.prototype.setHeaderField=function(e){this._headerField=e;return this};p.prototype.parse=function(e,r,t,s,a){var n=[],o={request:r,response:e,url:r?r.requestUri:e.requestUri};if(e.statusCode>=200&&e.statusCode<300){this._parseHeader(n,e,o)}else if(e.statusCode>=400&&e.statusCode<600){this._parseBody(n,e,o)}else{i.warning("No rule to parse OData response with status "+e.statusCode+" for messages")}this._propagateMessages(n,o,t,s,!a)};p.prototype._getAffectedTargets=function(e,r,t,s){var a=Object.assign({"":true},t,s),i,n=this._parseUrl(r.url).url;if(r.request&&r.request.key&&r.request.created){a[r.request.key]=true}if(n.startsWith(this._serviceUrl)){n=n.slice(this._serviceUrl.length+1)}i=this._metadata._getEntitySetByPath(n);if(i){a[i.name]=true}e.forEach(function(e){e.getTargets().forEach(function(e){var r,t,s;if(!e){return}s=e.replace(d,"");a[s]=true;t=s.lastIndexOf("/");if(t>0){r=s.slice(0,t);a[r]=true}})});return a};p.prototype._propagateMessages=function(e,r,t,s,a){var n,u=r.request.deepPath,l=[],p=u&&r.request.updateAggregatedMessages,h=r.request.headers&&r.request.headers["sap-messages"]==="transientOnly",f=[],c,g,y;function _(e,r){return r.some(function(e){return n[e]})||p&&e.aFullTargets.some(function(e){return e.startsWith(u)})}if(h){l=this._lastMessages;c=e.some(function(e){return!e.getPersistent()&&!e.getTechnical()});if(c){i.error("Unexpected non-persistent message in response, but requested only "+"transition messages",undefined,o)}}else{n=this._getAffectedTargets(e,r,t,s);g=r.response.statusCode;y=g>=200&&g<300;this._lastMessages.forEach(function(e){var r=e.getTargets().map(function(e){e=e.replace(d,"");var r=e.lastIndexOf(")/");if(r>0){e=e.substr(0,r+1)}return e});if(y||a){if(!e.getPersistent()&&_(e,r)){f.push(e)}else{l.push(e)}}else if(!e.getPersistent()&&e.getTechnical()&&_(e,r)){f.push(e)}else{l.push(e)}})}this.getProcessor().fireMessageChange({oldMessages:f,newMessages:e});this._lastMessages=l.concat(e)};p.prototype._createMessage=function(e,r,t){var s=e.target&&e.target.indexOf("/#TRANSIENT#")===0||e.transient||e.transition,i,n=typeof e.message==="object"?e.message.value:e.message,o=e["@sap.severity"]||e.severity;e.transition=!!s;i=this._createTargets(e,r,t);return new a({code:e.code||"",description:e.description,descriptionUrl:e.longtext_url||"",fullTarget:i.aDeepPaths,message:n,persistent:!!s,processor:this._processor,target:i.aTargets,technical:t,technicalDetails:{headers:r.response.headers,statusCode:r.response.statusCode},type:l[o]||o})};p.prototype._getFunctionTarget=function(e,r,t){var s="";var a;if(r.response&&r.response.headers&&r.response.headers["location"]){s=r.response.headers["location"];var n=s.lastIndexOf(this._serviceUrl);if(n>-1){s=s.substr(n+this._serviceUrl.length)}}else{var o=null;if(e.extensions){for(a=0;a<e.extensions.length;++a){if(e.extensions[a].name==="action-for"){o=e.extensions[a].value;break}}}var d;if(o){d=this._metadata._getEntityTypeByName(o)}else if(e.entitySet){d=this._metadata._getEntityTypeByPath(e.entitySet)}else if(e.returnType){d=this._metadata._getEntityTypeByName(e.returnType)}if(d){var u=this._metadata._getEntitySetByType(d);if(u&&d&&d.key&&d.key.propertyRef){var l="";var p;if(d.key.propertyRef.length===1){p=d.key.propertyRef[0].name;if(t.parameters[p]){l=t.parameters[p]}}else{var h=[];for(a=0;a<d.key.propertyRef.length;++a){p=d.key.propertyRef[a].name;if(t.parameters[p]){h.push(p+"="+t.parameters[p])}}l=h.join(",")}s="/"+u.name+"("+l+")"}else if(!u){i.error("Could not determine path of EntitySet for function call: "+t.url)}else{i.error("Could not determine keys of EntityType for function call: "+t.url)}}}return s};p._isResponseForCreate=function(e){var r=e.request,t=e.response;if(r.method==="POST"&&t.statusCode==201&&t.headers["location"]){return true}if(r.key&&r.created&&t.statusCode>=400){return false}};p.prototype._createTarget=function(r,t,s,a){var i,n,o,d,u,l,h,f,c,g="",y=t.request,_=t.response;if(r===undefined&&!s&&y.headers["sap-message-scope"]==="BusinessObject"||s&&a){return{deepPath:"",target:""}}r=r||"";r=r.startsWith("/#TRANSIENT#")?r.slice(12):r;if(r[0]!=="/"){n=p._isResponseForCreate(t);if(n===true){c=_.headers["location"]}else if(n===false){c=y.key}else{c=t.url}f=this._parseUrl(c);h=f.url;d=h.indexOf(this._serviceUrl);if(d>-1){l=h.slice(d+this._serviceUrl.length)}else{l="/"+h}if(!n){o=this._metadata._getFunctionImportMetadata(l,y.method);if(o){l=this._getFunctionTarget(o,t,f);g=l}}if(!g&&y.deepPath){g=y.deepPath}if(l.slice(l.lastIndexOf("/")).indexOf("(")>-1||!this._metadata._isCollection(l)){g=r?g+"/"+r:g;r=r?l+"/"+r:l}else{g=g+r;r=l+r}}i=this._processor.resolve(r,undefined,true);while(i&&i.lastIndexOf("/")>0&&i!==u){u=i;i=this._processor.resolve(i,undefined,true)||u}r=i||r;return{deepPath:this._metadata._getReducedPath(g||r),target:e._normalizeKey(r)}};p.prototype._createTargets=function(e,r,t){var s=[],a=Array.isArray(e.additionalTargets)?[e.target].concat(e.additionalTargets):[e.target],n,d=[],u=this;if(e.propertyref!==undefined&&a[0]!==undefined){i.warning("Used the message's 'target' property for target calculation; the property"+" 'propertyref' is deprecated and must not be used together with 'target'",r.url,o)}else if(a[0]===undefined){a[0]=e.propertyref}a.forEach(function(a){n=u._createTarget(a,r,t,e.transition);s.push(n.deepPath);d.push(n.target)});return{aDeepPaths:s,aTargets:d}};p.prototype._parseHeader=function(e,r,t){var s=this.getHeaderField();if(!r.headers){return}for(var a in r.headers){if(a.toLowerCase()===s.toLowerCase()){s=a}}if(!r.headers[s]){return}var n=r.headers[s];var o=null;try{o=JSON.parse(n);e.push(this._createMessage(o,t));if(Array.isArray(o.details)){for(var d=0;d<o.details.length;++d){e.push(this._createMessage(o.details[d],t))}}}catch(e){i.error("The message string returned by the back-end could not be parsed: '"+e.message+"'");return}};p.prototype._parseBody=function(e,r,t){var s=h(r);if(s&&s.indexOf("xml")>-1){this._parseBodyXML(e,r,t,s)}else{this._parseBodyJSON(e,r,t)}y(e)};p.prototype._addGenericError=function(e,r){e.push(this._createMessage({description:r.response.body,message:sap.ui.getCore().getLibraryResourceBundle().getText("CommunicationError"),severity:u.Error,transition:true},r,true))};p.prototype._parseBodyXML=function(e,r,t,s){try{var a=(new DOMParser).parseFromString(r.body,s);var n=g(a,["error","errordetail"]);if(!n.length){this._addGenericError(e,t);return}for(var o=0;o<n.length;++o){var d=n[o];var l={};l["severity"]=u.Error;for(var p=0;p<d.childNodes.length;++p){var h=d.childNodes[p];var f=h.nodeName;if(f==="errordetails"||f==="details"||f==="innererror"||f==="#text"){continue}if(f==="message"&&h.hasChildNodes()&&h.firstChild.nodeType!==window.Node.TEXT_NODE){for(var c=0;c<h.childNodes.length;++c){if(h.childNodes[c].nodeName==="value"){l["message"]=h.childNodes[c].text||h.childNodes[c].textContent}}}else{l[h.nodeName]=h.text||h.textContent}}e.push(this._createMessage(l,t,true))}}catch(r){this._addGenericError(e,t);i.error("Error message returned by server could not be parsed")}};p.prototype._parseBodyJSON=function(e,r,t){try{var s=JSON.parse(r.body);var a;if(s["error"]){a=s["error"]}else{a=s["odata.error"]}if(!a){this._addGenericError(e,t);i.error("Error message returned by server did not contain error-field");return}a["severity"]=u.Error;e.push(this._createMessage(a,t,true));var n=null;if(Array.isArray(a.details)){n=a.details}else if(a.innererror&&Array.isArray(a.innererror.errordetails)){n=a.innererror.errordetails}else{n=[]}for(var o=0;o<n.length;++o){e.push(this._createMessage(n[o],t,true))}}catch(r){this._addGenericError(e,t);i.error("Error message returned by server could not be parsed")}};p.prototype._parseUrl=function(e){var r={url:e,parameters:{},hash:""};var s=-1;s=e.indexOf("#");if(s>-1){r.hash=r.url.substr(s+1);r.url=r.url.substr(0,s)}s=e.indexOf("?");if(s>-1){var a=r.url.substr(s+1);r.parameters=t.parseQuery(a);r.url=r.url.substr(0,s)}return r};function h(e){if(e&&e.headers){for(var r in e.headers){if(r.toLowerCase()==="content-type"){return e.headers[r].replace(/([^;]*);.*/,"$1")}}}return false}var f=document.createElement("a");function c(e){f.href=e;return t.parse(f.href).path}function g(e,r){var t=[];var s={};for(var a=0;a<r.length;++a){s[r[a]]=true}var i=e;while(i){if(s[i.tagName]){t.push(i)}if(i.hasChildNodes()){i=i.firstChild}else{while(!i.nextSibling){i=i.parentNode;if(!i||i===e){i=null;break}}if(i){i=i.nextSibling}}}return t}function y(e){if(e.length>1){for(var r=1;r<e.length;r++){if(e[0].getCode()==e[r].getCode()&&e[0].getMessage()==e[r].getMessage()){e.shift();break}}}}return p});